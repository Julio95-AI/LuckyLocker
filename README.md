# 🎁 LuckyLocker - 幸运格子柜抽奖系统 v0.1.0

一个简单易用的格子柜抽奖系统，适合店铺做活动推广。用户扫码抽奖，中奖后获得格子密码取货。

## 📋 功能特点

- ✅ **用户抽奖**：扫码访问，每人限抽一次（同一IP/UA）
- ✅ **随机分配**：从8个格子中随机抽取，显示开锁密码
- ✅ **3秒动画**：抽奖时格子随机高亮切换，增加趣味性
- ✅ **冷却机制**：防止快速重复抽奖（不同IP需等待1-3分钟随机时间）
- ✅ **绿通凭证**：客服可设置凭证，允许用户绕过限制再次抽奖
- ✅ **预设产品池**：滚动显示的产品名称从产品池随机选择
- ✅ **后台管理**：格子管理、绿通凭证、产品池、查看记录
- ✅ **简单部署**：单文件后端，HTML前端，无需复杂配置

## 🏗️ 项目结构

```
LuckyLocker/
├── backend/
│   └── app.py              # Flask后端（包含所有API）
├── frontend/
│   ├── index.html          # 用户抽奖页面
│   └── admin.html          # 管理后台页面
├── requirements.txt        # Python依赖
└── README.md              # 本文件
```

## 🚀 快速开始

### 1. 安装依赖

确保已安装 Python 3.7 及以上版本，然后安装依赖：

```bash
cd LuckyLocker
pip install -r requirements.txt
```

### 2. 启动服务

```bash
cd backend
python app.py
```

启动成功后，你会看到：

```
==================================================
LuckyLocker 抽奖系统启动
前端访问: http://localhost:5000
管理后台: http://localhost:5000/admin.html
==================================================
```

### 3. 访问系统

- **用户抽奖页面**：`http://localhost:5000`
- **管理后台**：`http://localhost:5000/admin.html`

## 📱 使用流程

### 用户端（抽奖）

1. 用户扫码或访问抽奖页面
2. 点击"立即抽奖"按钮，观看3秒转动动画
3. 系统随机分配格子，显示开锁密码（如：`2-038`）
4. 用户凭密码到格子柜取货
5. 如需再次抽奖，输入客服提供的"绿通凭证"

### 管理端（后台）

1. 访问 `http://localhost:5000/admin.html`
2. **仪表盘**：查看今日抽奖统计
3. **格子管理**：
   - 查看每个格子的开锁密码（格式：格子号-密码）
   - 设置每个格子的密码
   - 设置每个格子的商品名称（仅供参考，实际显示从产品池随机）
   - 设置格子可用/不可用状态
4. **系统配置**：
   - 设置每日中奖名额（1-8人）
   - 设置活动状态（进行中/今日已结束/活动已停止）
5. **绿通凭证**：
   - 添加新凭证（手机号/订单号/自定义码）
   - 设置凭证剩余抽奖次数和有效期
   - 查看和删除已有凭证
6. **产品池**：
   - 添加新产品名称
   - 启用/禁用产品（用于轮播显示）
   - 删除产品
7. **抽奖记录**：查看今天所有抽奖记录

## ⚙️ 配置说明

### 防作弊机制

1. **IP/UA识别**：同一IP和User-Agent组合只能抽一次
2. **冷却时间**：不同IP/UA需等待1-3分钟随机时间才能再次抽奖
3. **提示信息**：
   - 已抽过：显示"免费次数已满，请联系客服通过绿通抽奖"
   - 冷却中：显示"数据同步中，请稍后刷新重试"

### 绿通凭证系统

1. 客服在后台添加凭证（手机号、订单号或自定义码）
2. 设置剩余抽奖次数和有效期（小时）
3. 用户在前端输入凭证后可绕过限制抽奖
4. 凭证用完或过期后自动失效

### 产品池管理

- 在后台"产品池"中添加产品名称
- 前端会从启用的产品中随机选择显示
- 每5秒自动刷新显示的产品名称
- 产品名称不一定对应格子实际商品

### 活动状态

- **进行中**：正常抽奖
- **今日已结束**：今天活动结束，显示"今天已抽完"
- **活动已停止**：整个活动结束，显示"活动已结束"

### 格子密码设置

建议密码格式：`001`, `002`, `003` ... `008`
实际开锁密码会显示为：`格子号-密码`，例如 `2-038` 表示2号格子，密码038

## 🌐 部署到服务器

### 方案1：直接部署（适合小规模使用）

1. 将整个项目上传到服务器
2. 安装依赖：`pip install -r requirements.txt`
3. 修改 `app.py` 最后一行，改为生产模式：
   ```python
   app.run(host='0.0.0.0', port=5000, debug=False)
   ```
4. 启动服务：`python app.py`

### 方案2：使用 Nginx + Gunicorn（推荐生产环境）

1. 安装 Gunicorn：
   ```bash
   pip install gunicorn
   ```

2. 启动 Gunicorn：
   ```bash
   cd backend
   gunicorn -w 4 -b 0.0.0.0:5000 app:app
   ```

3. 配置 Nginx 反向代理：
   ```nginx
   server {
       listen 80;
       server_name your-domain.com;

       location / {
           proxy_pass http://127.0.0.1:5000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
       }
   }
   ```

### 方案3：使用 Cloudflare + 服务器

1. 将域名 DNS 托管到 Cloudflare
2. 在服务器上部署项目（方案1或2）
3. 在 Cloudflare 添加 A 记录指向服务器IP
4. 开启 Cloudflare 的 CDN 和 SSL

## 📊 数据库说明

项目使用 SQLite 数据库，数据库文件会自动创建在 `backend/luckylocker.db`

包含5个表：
- `lockers`：格子柜信息（8个格子）
- `draw_records`：抽奖记录（含冷却时间字段）
- `system_config`：系统配置
- `greenlist`：绿通凭证表（凭证标识、剩余次数、有效期）
- `product_pool`：预设产品池（用于前端随机显示）

### 备份数据库

```bash
# 备份
cp backend/luckylocker.db backend/luckylocker_backup.db

# 恢复
cp backend/luckylocker_backup.db backend/luckylocker.db
```

### 重置数据库

如果需要清空所有数据，删除数据库文件即可：
```bash
rm backend/luckylocker.db
# 重新启动 app.py 会自动创建新数据库
```

## 🎯 常见问题

### Q1: 用户如何被识别为"同一个人"？

A: 系统通过用户的 IP 地址 + User-Agent（浏览器信息）生成唯一标识。同一设备只能抽一次（除非使用绿通凭证）。

### Q2: 冷却机制是如何工作的？

A: 每次有人中奖后，记录时间。下一个人抽奖时，如果是不同的IP/UA，需要等待1-3分钟随机时间。这防止了快速换设备抽奖的行为。

### Q3: 如何生成绿通凭证？

A: 在管理后台 > 绿通凭证 > 添加新凭证，输入手机号/订单号/自定义码，设置剩余次数和有效期即可。

### Q4: 格子被抽走后如何重置？

A: 在管理后台 > 格子管理中，勾选"可用状态"并保存即可。不需要全部重置，逐个管理更灵活。

### Q5: 如何更改端口？

A: 修改 `backend/app.py` 最后一行的 `port=5000` 改为其他端口，例如 `port=8080`

### Q6: 可以用微信小程序吗？

A: 可以！前端代码已经兼容移动端，你可以：
1. 将 HTML 页面部署到服务器
2. 生成二维码让用户扫码访问
3. 或者参考 `frontend/index.html` 的 API 调用方式，开发微信小程序

### Q7: 如何自定义抽奖动画时间？

A: 打开 `frontend/index.html`，找到 `spinAnimation()` 函数中的 `duration = 3000`，修改为你想要的毫秒数（例如5000表示5秒）。

## 🔒 安全建议

1. **生产环境**：
   - 修改 `app.py` 中的 `debug=False`
   - 为管理后台添加密码保护（可以在 Nginx 层面配置 Basic Auth）
   
2. **防止作弊（已内置）**：
   - ✅ IP/UA双重识别
   - ✅ 1-3分钟随机冷却时间
   - ✅ 绿通凭证系统（可设置有效期和次数）
   - 可选：集成微信登录获取OpenID（更强的身份识别）

3. **数据安全**：
   - 定期备份数据库文件
   - 设置文件权限，防止未授权访问
   - 定期清理过期的绿通凭证

## 📞 技术支持

如遇问题，请检查：
1. Python 版本是否 >= 3.7
2. 依赖是否正确安装
3. 端口是否被占用
4. 防火墙是否开放端口

## 📄 许可证

MIT License - 自由使用，无需授权

---

**祝你的活动大卖！** 🎉
