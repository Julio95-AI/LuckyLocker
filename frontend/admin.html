<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuckyLocker - ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .tab-button {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .tab-button.active {
            background: #667eea;
            color: white;
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .stat-card .label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .locker-list {
            display: grid;
            gap: 15px;
        }
        
        .locker-item {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 15px;
            align-items: center;
        }
        
        .locker-item .locker-id {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            width: 50px;
            text-align: center;
        }
        
        .locker-item .locker-info {
            flex: 1;
        }
        
        .locker-item input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .locker-item button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .locker-item button:hover {
            background: #5568d3;
        }
        
        .locker-item.unavailable {
            background: #f5f5f5;
            opacity: 0.7;
        }
        
        .config-form {
            max-width: 600px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .records-table th,
        .records-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .records-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .records-table tr:hover {
            background: #f8f9fa;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-secondary {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .message {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            display: none;
        }
        
        .message.show {
            display: block;
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ LuckyLocker ç®¡ç†åå°</h1>
        <p style="color: #666; margin-top: 5px;">ç®¡ç†æ ¼å­æŸœã€é…ç½®æ´»åŠ¨ã€æŸ¥çœ‹è®°å½•</p>
        
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('dashboard')">ä»ªè¡¨ç›˜</button>
            <button class="tab-button" onclick="switchTab('lockers')">æ ¼å­ç®¡ç†</button>
            <button class="tab-button" onclick="switchTab('config')">ç³»ç»Ÿé…ç½®</button>
            <button class="tab-button" onclick="switchTab('records')">æŠ½å¥–è®°å½•</button>
        </div>
    </div>

    <!-- ä»ªè¡¨ç›˜ -->
    <div class="section active" id="dashboard">
        <h2>ğŸ“Š ä»Šæ—¥æ•°æ®</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">ä»Šæ—¥æŠ½å¥–æ¬¡æ•°</div>
                <div class="value" id="statTotalDraws">0</div>
            </div>
            <div class="stat-card">
                <div class="label">ä»Šæ—¥ä¸­å¥–äººæ•°</div>
                <div class="value" id="statWinners">0</div>
            </div>
            <div class="stat-card">
                <div class="label">å¯ç”¨æ ¼å­æ•°</div>
                <div class="value" id="statAvailableLockers">8</div>
            </div>
        </div>
    </div>

    <!-- æ ¼å­ç®¡ç† -->
    <div class="section" id="lockers">
        <h2>ğŸ—„ï¸ æ ¼å­æŸœç®¡ç†</h2>
        <button class="btn-secondary" onclick="resetAllLockers()" style="margin-bottom: 20px;">
            é‡ç½®æ‰€æœ‰æ ¼å­ä¸ºå¯ç”¨
        </button>
        <div id="message-lockers" class="message"></div>
        <div class="locker-list" id="lockerList">
            <!-- åŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <!-- ç³»ç»Ÿé…ç½® -->
    <div class="section" id="config">
        <h2>âš™ï¸ ç³»ç»Ÿé…ç½®</h2>
        <div id="message-config" class="message"></div>
        <div class="config-form">
            <div class="form-group">
                <label>æ¯æ—¥ä¸­å¥–åé¢é™åˆ¶</label>
                <input type="number" id="configDailyLimit" min="1" max="8" value="2">
                <small style="color: #666; display: block; margin-top: 5px;">
                    æ¯å¤©æœ€å¤šäº§ç”Ÿå¤šå°‘ä¸ªå¹¸è¿é¡¾å®¢
                </small>
            </div>
            
            <div class="form-group">
                <label>æ´»åŠ¨çŠ¶æ€</label>
                <select id="configActivityStatus">
                    <option value="active">è¿›è¡Œä¸­</option>
                    <option value="finished">ä»Šæ—¥å·²ç»“æŸ</option>
                    <option value="disabled">æ´»åŠ¨å·²åœæ­¢</option>
                </select>
            </div>
            
            <button class="btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <!-- æŠ½å¥–è®°å½• -->
    <div class="section" id="records">
        <h2>ğŸ“‹ ä»Šæ—¥æŠ½å¥–è®°å½•</h2>
        <table class="records-table">
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>ç”¨æˆ·ID</th>
                    <th>æ ¼å­å·</th>
                    <th>å•†å“</th>
                    <th>è®¢å•å·</th>
                    <th>çŠ¶æ€</th>
                </tr>
            </thead>
            <tbody id="recordsTableBody">
                <!-- åŠ¨æ€åŠ è½½ -->
            </tbody>
        </table>
    </div>

    <script>
        const API_BASE = '';
        
        // åˆ‡æ¢æ ‡ç­¾
        function switchTab(tabName) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // æ›´æ–°å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'dashboard') loadDashboard();
            if (tabName === 'lockers') loadLockers();
            if (tabName === 'config') loadConfig();
            if (tabName === 'records') loadRecords();
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, isError = false) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = isError ? 'message message-error show' : 'message message-success show';
            setTimeout(() => {
                el.classList.remove('show');
            }, 3000);
        }
        
        // åŠ è½½ä»ªè¡¨ç›˜
        async function loadDashboard() {
            try {
                const [statusRes, recordsRes] = await Promise.all([
                    fetch(API_BASE + '/api/status'),
                    fetch(API_BASE + '/api/admin/records')
                ]);
                
                const status = await statusRes.json();
                const records = await recordsRes.json();
                
                document.getElementById('statTotalDraws').textContent = records.records.length;
                document.getElementById('statWinners').textContent = status.today_count || 0;
                
                // è·å–å¯ç”¨æ ¼å­æ•°
                const lockersRes = await fetch(API_BASE + '/api/admin/lockers');
                const lockers = await lockersRes.json();
                const available = lockers.lockers.filter(l => l.is_available === 1).length;
                document.getElementById('statAvailableLockers').textContent = available;
            } catch (err) {
                console.error('åŠ è½½ä»ªè¡¨ç›˜å¤±è´¥:', err);
            }
        }
        
        // åŠ è½½æ ¼å­åˆ—è¡¨
        async function loadLockers() {
            try {
                const res = await fetch(API_BASE + '/api/admin/lockers');
                const data = await res.json();
                
                const listEl = document.getElementById('lockerList');
                listEl.innerHTML = '';
                
                data.lockers.forEach(locker => {
                    const div = document.createElement('div');
                    div.className = 'locker-item' + (locker.is_available ? '' : ' unavailable');
                    div.innerHTML = `
                        <div class="locker-id">${locker.id}</div>
                        <div class="locker-info">
                            <input type="text" 
                                   id="password-${locker.id}" 
                                   value="${locker.password}" 
                                   placeholder="æ ¼å­å¯†ç ">
                            <input type="text" 
                                   id="product-${locker.id}" 
                                   value="${locker.product_name || ''}" 
                                   placeholder="å•†å“åç§°">
                            <label style="font-size: 14px; margin-top: 5px; display: block;">
                                <input type="checkbox" 
                                       id="available-${locker.id}" 
                                       ${locker.is_available ? 'checked' : ''}>
                                å¯ç”¨çŠ¶æ€
                            </label>
                        </div>
                        <button onclick="updateLocker(${locker.id})">ä¿å­˜</button>
                    `;
                    listEl.appendChild(div);
                });
            } catch (err) {
                console.error('åŠ è½½æ ¼å­åˆ—è¡¨å¤±è´¥:', err);
            }
        }
        
        // æ›´æ–°æ ¼å­ä¿¡æ¯
        async function updateLocker(lockerId) {
            const password = document.getElementById(`password-${lockerId}`).value;
            const productName = document.getElementById(`product-${lockerId}`).value;
            const isAvailable = document.getElementById(`available-${lockerId}`).checked ? 1 : 0;
            
            try {
                const res = await fetch(API_BASE + `/api/admin/locker/${lockerId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password,
                        product_name: productName,
                        is_available: isAvailable
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    showMessage('message-lockers', 'æ›´æ–°æˆåŠŸï¼');
                } else {
                    showMessage('message-lockers', 'æ›´æ–°å¤±è´¥', true);
                }
            } catch (err) {
                console.error('æ›´æ–°æ ¼å­å¤±è´¥:', err);
                showMessage('message-lockers', 'æ›´æ–°å¤±è´¥', true);
            }
        }
        
        // é‡ç½®æ‰€æœ‰æ ¼å­
        async function resetAllLockers() {
            if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ ¼å­ä¸ºå¯ç”¨çŠ¶æ€å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(API_BASE + '/api/admin/reset_lockers', {
                    method: 'POST'
                });
                const data = await res.json();
                
                if (data.success) {
                    showMessage('message-lockers', 'é‡ç½®æˆåŠŸï¼');
                    loadLockers();
                } else {
                    showMessage('message-lockers', 'é‡ç½®å¤±è´¥', true);
                }
            } catch (err) {
                console.error('é‡ç½®å¤±è´¥:', err);
                showMessage('message-lockers', 'é‡ç½®å¤±è´¥', true);
            }
        }
        
        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const res = await fetch(API_BASE + '/api/admin/config');
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('configDailyLimit').value = data.config.daily_limit;
                    document.getElementById('configActivityStatus').value = data.config.activity_status;
                }
            } catch (err) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', err);
            }
        }
        
        // ä¿å­˜é…ç½®
        async function saveConfig() {
            const dailyLimit = document.getElementById('configDailyLimit').value;
            const activityStatus = document.getElementById('configActivityStatus').value;
            
            try {
                const res = await fetch(API_BASE + '/api/admin/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        daily_limit: parseInt(dailyLimit),
                        activity_status: activityStatus
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    showMessage('message-config', 'é…ç½®ä¿å­˜æˆåŠŸï¼');
                } else {
                    showMessage('message-config', 'ä¿å­˜å¤±è´¥', true);
                }
            } catch (err) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', err);
                showMessage('message-config', 'ä¿å­˜å¤±è´¥', true);
            }
        }
        
        // åŠ è½½æŠ½å¥–è®°å½•
        async function loadRecords() {
            try {
                const res = await fetch(API_BASE + '/api/admin/records');
                const data = await res.json();
                
                const tbody = document.getElementById('recordsTableBody');
                tbody.innerHTML = '';
                
                if (data.records.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">æš‚æ— è®°å½•</td></tr>';
                    return;
                }
                
                data.records.forEach(record => {
                    const tr = document.createElement('tr');
                    const time = new Date(record.draw_time).toLocaleTimeString('zh-CN');
                    const userId = record.user_id.substring(0, 8) + '...';
                    const lockerId = record.locker_id || '-';
                    const productName = record.product_name || '-';
                    const orderCode = record.order_code || '-';
                    const status = record.locker_id 
                        ? '<span class="badge badge-success">ä¸­å¥–</span>'
                        : '<span class="badge badge-secondary">æœªä¸­</span>';
                    
                    tr.innerHTML = `
                        <td>${time}</td>
                        <td>${userId}</td>
                        <td>${lockerId}</td>
                        <td>${productName}</td>
                        <td>${orderCode}</td>
                        <td>${status}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error('åŠ è½½è®°å½•å¤±è´¥:', err);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        loadDashboard();
    </script>
</body>
</html>
